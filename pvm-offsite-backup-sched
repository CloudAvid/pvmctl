#!/bin/bash
# Schedule offsite-back base of $rcf_offsite_backup content

. /etc/pvm.conf

myname=$($uname -n)
vms=$( $pvmctl "status" | $sed -e "1d" )


(
	flock -s 201
	$sed -i -e "/# Automated Generated By PVM: Start/,/# Automated Generated By PVM: End/d" /etc/crontab
	echo "# Automated Generated By PVM: Start" >> /etc/crontab
	for vm in ${vms[@]}; do
		vm_sched=$($sed -n -e "/ $vm$/p" "$rcf_offback_sched")
		if [[ ! -z $vm_sched ]]; then
			echo "$vm_sched" >> /etc/crontab
		fi
	done
	offnode=$(read_config_file $cf_offbacknode_4_offvm)
	if [[ $offnode = $myname ]]; then
		vms=($( $pcad status | $grep service | $cut -d ":" -f 2 ))
		vms_no=$((${#vms[@]} / 3))
		for ((i=0; i<$vms_no; ++i)); do
			if [[ "${vms[i*3+2]}" = "disabled" || "${vms[i*3+2]}" = "stopped" ||
				"${vms[i*3+2]}" = "failed" ]]; then
				vm_sched=$($sed -n -e "/ ${vms[i*3]}$/p" "$rcf_offback_sched")
				if [[ ! -z $vm_sched ]]; then
					echo "$vm_sched" >> /etc/crontab
				fi
			fi
		done
	fi
	echo "# Automated Generated By PVM: End" >> /etc/crontab
) 201>$lck_offback_sched

service crond restart >/dev/null 2>&1

